import json
from pathlib import Path

from dcv_benchmark.data_factory.base import BaseCorpusLoader
from dcv_benchmark.models.data_factory import RawSample
from dcv_benchmark.utils.logger import get_logger

logger = get_logger()


class SquadLoader(BaseCorpusLoader):
    """
    Loader for SQuAD-style JSON files (as generated by scripts/fetch_squad_data.py).
    Expected structure: { "data": [ { "id":..., "query":..., "source_document":... } ] }
    """

    def load(self, file_path: str) -> list[RawSample]:
        path = Path(file_path)
        if not path.exists():
            raise FileNotFoundError(f"Corpus file not found: {path}")

        logger.info(f"Loading corpus from {path}...")

        with open(path, encoding="utf-8") as f:
            content = json.load(f)

        # Handle both raw list and dict wrapper
        data_items = content.get("data", []) if isinstance(content, dict) else content

        samples: list[RawSample] = []
        for item in data_items:
            # Validate required fields
            if "query" not in item or "source_document" not in item:
                logger.warning(f"Skipping malformed item {item.get('id', 'unknown')}")
                continue

            samples.append(
                RawSample(
                    id=item.get("id", str(len(samples))),
                    query=item["query"],
                    reference_answer=item.get("reference_answer"),
                    source_document=item["source_document"],
                    metadata={"title": item.get("title", "unknown")},
                )
            )

        logger.info(f"Loaded {len(samples)} valid samples.")
        return samples
